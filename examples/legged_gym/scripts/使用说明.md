# Ray集群管理脚本使用说明

## 概述

本项目提供了两个Ray集群管理脚本：

1. **`run_ray_node.sh`** - 主要的Ray集群管理脚本
2. **`test_ray_script.sh`** - 测试脚本，用于验证环境配置

## 快速开始

### 1. 环境准备

确保已安装conda并创建了orca环境：

```bash
# 检查conda环境
conda env list

# 如果没有orca环境，创建它
conda create -n orca python=3.12
conda activate orca

# 安装Ray
pip install ray
```

### 2. 测试环境

在开始使用之前，建议先运行测试脚本：

```bash
cd examples/legged_gym/scripts
./test_ray_script.sh test
```

这将验证：
- Conda环境是否正确
- Ray是否正确安装
- 配置文件是否可以正确读取

### 3. 启动Ray集群

#### 启动Head节点

在head节点机器上运行：

```bash
cd examples/legged_gym/scripts
./run_ray_node.sh head
```

这将：
- 自动激活orca conda环境
- 从配置文件读取IP地址（当前为192.168.1.100）
- 启动Ray head节点
- 显示Ray集群地址

#### 启动Worker节点

在worker节点机器上运行：

```bash
cd examples/legged_gym/scripts
./run_ray_node.sh worker
```

或者指定head节点IP：

```bash
./run_ray_node.sh worker 192.168.1.100
```

### 4. 管理集群

#### 查看集群状态

```bash
./run_ray_node.sh status
```

#### 停止集群

```bash
./run_ray_node.sh stop
```

#### 查看帮助

```bash
./run_ray_node.sh help
```

## 配置文件

脚本会自动读取 `examples/legged_gym/configs/rllib_appo_config.yaml` 文件中的配置：

```yaml
orcagym_addresses: ["192.168.1.100:50051"]    # 配置成你的头结点ip地址
```

**重要**：请根据你的实际网络环境修改这个IP地址。

## 网络配置

### 端口说明

- **Ray服务端口**：6379
- **Dashboard端口**：8265（如果安装了完整版Ray）
- **OrcaGym端口**：50051

### 防火墙设置

确保以下端口在head节点上开放：

```bash
# Ubuntu/Debian
sudo ufw allow 6379
sudo ufw allow 8265
sudo ufw allow 50051

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=6379/tcp
sudo firewall-cmd --permanent --add-port=8265/tcp
sudo firewall-cmd --permanent --add-port=50051/tcp
sudo firewall-cmd --reload
```

## 故障排除

### 1. Conda环境问题

**问题**：`CondaError: Run 'conda init' before 'conda activate'`

**解决方案**：
```bash
conda init bash
source ~/.bashrc
conda activate orca
```

### 2. Ray安装问题

**问题**：Ray命令不可用

**解决方案**：
```bash
conda activate orca
pip install ray
```

### 3. 端口冲突

**问题**：端口已被占用

**解决方案**：
```bash
# 停止现有Ray进程
ray stop

# 或者强制杀死进程
pkill -f "ray start"
```

### 4. 网络连接问题

**问题**：Worker节点无法连接到Head节点

**解决方案**：
```bash
# 测试网络连接
telnet 192.168.1.100 6379

# 检查防火墙设置
sudo ufw status
```

### 5. 配置文件问题

**问题**：无法读取配置文件

**解决方案**：
```bash
# 检查配置文件是否存在
ls -la ../configs/rllib_appo_config.yaml

# 检查配置文件格式
cat ../configs/rllib_appo_config.yaml | grep orcagym_addresses
```

## 完整工作流程示例

### 1. 在Head节点上

```bash
# 进入项目目录
cd /path/to/OrcaGym/examples/legged_gym/scripts

# 测试环境
./test_ray_script.sh test

# 启动head节点
./run_ray_node.sh head

# 验证启动成功
./run_ray_node.sh status
```

### 2. 在Worker节点上

```bash
# 进入项目目录
cd /path/to/OrcaGym/examples/legged_gym/scripts

# 测试环境
./test_ray_script.sh test

# 连接到head节点
./run_ray_node.sh worker

# 验证连接成功
./run_ray_node.sh status
```

### 3. 运行训练

```bash
# 在任意节点上运行训练
cd /path/to/OrcaGym/examples/legged_gym
python run_legged_rl.py --config configs/rllib_appo_config.yaml --train
```

## 注意事项

1. **环境一致性**：确保所有节点都使用相同的conda环境和Python版本
2. **网络环境**：确保所有节点都在同一网络环境中，能够相互访问
3. **资源分配**：根据实际硬件配置调整Ray的资源分配参数
4. **日志监控**：建议监控Ray的日志输出，及时发现问题
5. **备份配置**：在修改配置文件前，建议备份原始配置

## 高级配置

### 自定义端口

如果需要使用不同的端口，可以修改脚本中的端口变量：

```bash
# 在脚本中修改
RAY_PORT=6380
RAY_DASHBOARD_PORT=8266
```

### 资源限制

可以在启动命令中添加资源限制：

```bash
# 限制CPU和GPU使用
ray start --head --port=6379 --num-cpus=4 --num-gpus=1
```

### 持久化存储

可以指定Ray的临时目录：

```bash
# 使用自定义临时目录
ray start --head --port=6379 --temp-dir=/data/ray
```

## 联系支持

如果遇到问题，请：

1. 首先运行测试脚本：`./test_ray_script.sh test`
2. 检查网络连接和防火墙设置
3. 查看Ray日志输出
4. 参考Ray官方文档：https://docs.ray.io/ 