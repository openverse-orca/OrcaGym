# Lite3 原项目 vs OrcaGym 完整对比

## 📊 对比概览

本文档详细对比了原始项目（Lite3_rl_deploy）和OrcaGym迁移版本的控制、驱动和仿真频率配置。

---

## 1. 仿真频率对比

### 1.1 物理仿真频率

| 参数 | 原项目 (Lite3_rl_deploy) | OrcaGym 当前版本 | 说明 |
|------|-------------------------|-----------------|------|
| **物理时间步长** | 0.001s (1ms) | 0.001s (1ms) | ✅ 一致 |
| **物理仿真频率** | 1000 Hz | 1000 Hz | ✅ 一致 |
| **FRAME_SKIP** | 5 | 5 | ✅ 一致 |
| **ACTION_SKIP** | 4 | 4 | ✅ 一致 |
| **策略更新频率** | 50 Hz | 50 Hz | ✅ 一致 |
| **策略更新时间步** | 0.02s (20ms) | 0.02s (20ms) | ✅ 一致 |

**计算公式**：
- 策略更新频率 = 1 / (TIME_STEP × FRAME_SKIP × ACTION_SKIP)
- 策略更新时间步 = TIME_STEP × FRAME_SKIP × ACTION_SKIP = 0.001 × 5 × 4 = 0.02s

### 1.2 控制循环频率

| 参数 | 原项目 | OrcaGym 当前版本 | 说明 |
|------|--------|----------------|------|
| **PD控制频率** | 200 Hz | 200 Hz | FRAME_SKIP=5, 1000/5=200Hz |
| **策略推理频率** | 50 Hz | 50 Hz | ACTION_SKIP=4, 200/4=50Hz |
| **实时控制频率** | 50 Hz | 50 Hz | 使用REALTIME_STEP控制 |

---

## 2. 控制参数对比

### 2.1 键盘控制速度

| 控制类型 | 原项目配置 | OrcaGym当前配置 | 实际速度值 | 归一化后 | 状态 |
|---------|-----------|----------------|-----------|---------|------|
| **前进 (W)** | 0.5 m/s | 0.5 m/s | 0.5 m/s | 1.0 | ✅ 一致 |
| **后退 (S)** | -0.5 m/s | -0.5 m/s | **-0.25 m/s** | **-0.5** | ⚠️ 降低50% |
| **左移 (A)** | 0.3 m/s | 0.3 m/s | 0.3 m/s | 1.0 | ✅ 一致 |
| **右移 (D)** | -0.3 m/s | -0.3 m/s | -0.3 m/s | -1.0 | ✅ 一致 |
| **转向速度 (Q/E)** | ±0.785 rad/s | ±0.785 rad/s | ±0.785 rad/s | ±1.0 | ✅ 一致 |
| **Turbo倍数** | 3.0x | 3.0x | 3.0x | - | ✅ 一致 |

**说明**：
- ✅ **左右移动已修复为对称**：A键和D键都使用完整速度，归一化后为±1.0
- ⚠️ **后退速度降低50%**：当前使用-0.25 m/s（归一化后-0.5），以改善策略对负值命令的响应
- ✅ **前进和转向速度**：与原项目完全一致

### 2.2 命令归一化

| 参数 | 原项目 | OrcaGym 当前版本 | 说明 |
|------|--------|----------------|------|
| **前进/后退归一化** | 除以 0.5 | 除以 0.5 | ✅ 一致 |
| **左右移动归一化** | 除以 0.3 | 除以 0.3 | ✅ 一致 |
| **角速度归一化** | 除以 0.8 | 除以 0.8 | ✅ 一致 |
| **max_cmd_vel** | [0.8, 0.8, 0.8] | [0.8, 0.8, 0.8] | ✅ 一致 |

**归一化公式**：
```python
commands_normalized = [
    lin_vel[0] / 0.5,      # 前进/后退: [-1, 1]
    lin_vel[1] / 0.3,      # 左右: [-1, 1]
    ang_vel / 0.8           # 角速度: [-1, 1]
]
```

**观测计算**：
```python
commands_scaled = commands_normalized * max_cmd_vel
# 例如：前进命令 1.0 * 0.8 = 0.8
```

---

## 3. 驱动参数对比

### 3.1 PD控制参数

| 参数 | 原项目 (Lite3_rl_deploy) | OrcaGym 当前版本 | 说明 |
|------|-------------------------|-----------------|------|
| **控制类型** | Position Control | Position Control | ✅ 一致 |
| **Kp (位置增益)** | [30] × 12 | [30] × 12 | ✅ 一致 |
| **Kd (速度增益)** | [1.0] × 12 | [1.0] × 12 | ✅ 已修改为一致 |
| **Kd说明** | 原始实现使用1.0 | 已修改为1.0 | ✅ 现在一致 |
| **base_born_height_offset** | 0.001 m | 0.101 m | ✅ 已调整（提高10cm） |

**PD控制公式**：
```python
torque = Kp * (target_pos - current_pos) + Kd * (target_vel - current_vel)
```

### 3.2 动作缩放

| 参数 | 原项目 | OrcaGym 当前版本 | 说明 |
|------|--------|----------------|------|
| **action_scale** | [0.125, 0.25, 0.25] × 4 | [0.25] × 12 | ⚠️ 不同 |
| **动作范围** | 不同关节不同 | 所有关节相同 | 简化处理 |
| **动作归一化** | 需要除以action_scale | 需要除以action_scale | ✅ 一致 |

**动作计算**：
```python
# 策略输出：policy_action (相对default位置的偏移)
target_dof_pos = policy_action * action_scale + dof_pos_default
action_offset = target_dof_pos - neutral_joint_values
normalized_action = action_offset / action_scale  # 归一化到[-1, 1]
```

### 3.3 默认关节位置

| 参数 | 原项目 | OrcaGym 当前版本 | 说明 |
|------|--------|----------------|------|
| **neutral_joint_angles** | [0, -1.0, 1.8] × 4 | [0, -1.0, 1.8] × 4 | ✅ 一致 |
| **dof_pos_default_policy** | [0, -0.8, 1.6] × 4 | [0, -0.8, 1.6] × 4 | ✅ 一致 |
| **用途** | neutral用于PD控制 | neutral用于PD控制 | ✅ 一致 |
| **用途** | default用于观测计算 | default用于观测计算 | ✅ 一致 |

---

## 4. 观测参数对比

### 4.1 观测缩放参数

| 参数 | 原项目 | OrcaGym 当前版本 | 说明 |
|------|--------|----------------|------|
| **omega_scale** | 0.25 | 0.25 | ✅ 一致 |
| **dof_vel_scale** | 0.05 | 0.05 | ✅ 一致 |
| **max_cmd_vel** | [0.8, 0.8, 0.8] | [0.8, 0.8, 0.8] | ✅ 一致 |

### 4.2 观测维度

| 观测类型 | 维度 | 原项目 | OrcaGym | 说明 |
|---------|------|--------|---------|------|
| **base_ang_vel** | 3 | omega_scale × ang_vel | omega_scale × ang_vel | ✅ 一致 |
| **projected_gravity** | 3 | 投影重力 | 投影重力 | ✅ 一致 |
| **commands** | 3 | normalized × max_cmd_vel | normalized × max_cmd_vel | ✅ 一致 |
| **dof_pos** | 12 | 相对default位置 | 相对default位置 | ✅ 一致 |
| **dof_vel** | 12 | dof_vel_scale × vel | dof_vel_scale × vel | ✅ 一致 |
| **last_actions** | 12 | 上一动作 | 上一动作 | ✅ 一致 |
| **总计** | 45 | 45维 | 45维 | ✅ 一致 |

---

## 5. 关键差异总结

### 5.1 已修复的差异

| 差异项 | 原项目 | OrcaGym初始 | OrcaGym当前 | 状态 |
|--------|--------|------------|------------|------|
| **左右控制方向** | Q/E控制 | A/D控制 | A/D控制（已修复对称） | ✅ 已修复 |
| **左右速度对称性** | 对称 | 不对称（D键70%缩放） | 对称（A/D都完整速度） | ✅ 已修复 |
| **后退速度** | -0.5 m/s | -0.5 m/s | **-0.25 m/s（50%缩放）** | ⚠️ 保留缩放 |
| **命令归一化** | 正确归一化 | 未归一化 | 正确归一化 | ✅ 已修复 |
| **时间控制** | REALTIME_STEP | dt | REALTIME_STEP | ✅ 已修复 |
| **Kd值** | 1.0 | 0.7 | 1.0 | ✅ 已修复 |
| **初始高度** | 0.001 m | 0.001 m | 0.101 m（提高10cm） | ✅ 已优化 |

### 5.2 保留的差异（设计选择）

| 差异项 | 原项目 | OrcaGym当前 | 影响 | 说明 |
|--------|--------|------------|------|------|
| **后退速度缩放** | -0.5 m/s | -0.25 m/s（50%） | 降低后退速度 | ⚠️ 为改善策略响应而保留 |
| **action_scale** | 不同关节不同 | 所有关节相同（0.25） | 简化处理 | ✅ 当前可用 |
| **地形** | terrain_test_usda | terrain_ellipsoid_low_usda | 无障碍物 | ✅ 已优化 |
| **命令平滑** | 无 | 指数移动平均（α=0.3） | 减少命令突变 | ✅ 改善稳定性 |

---

## 6. 性能对比

### 6.1 实时性能

| 指标 | 原项目 | OrcaGym当前 | 说明 |
|------|--------|------------|------|
| **策略推理频率** | 50 Hz | 50 Hz | ✅ 一致 |
| **PD控制频率** | 200 Hz | 200 Hz | ✅ 一致 |
| **物理仿真频率** | 1000 Hz | 1000 Hz | ✅ 一致 |
| **实时控制延迟** | ~20ms | ~20ms | ✅ 一致 |

### 6.2 控制响应

| 控制方向 | 原项目 | OrcaGym当前 | 归一化值 | 状态 |
|---------|--------|------------|---------|------|
| **前进 (W)** | 流畅 | 流畅 | 1.0 | ✅ 正常 |
| **后退 (S)** | 流畅 | 流畅（降低50%） | -0.5 | ⚠️ 速度降低 |
| **左移 (A)** | 流畅 | 流畅 | 1.0 | ✅ 正常 |
| **右移 (D)** | 流畅 | 流畅 | -1.0 | ✅ 正常 |

**说明**：
- ✅ **左右移动已修复为对称**：A键和D键归一化后为±1.0，速度一致
- ⚠️ **后退速度降低**：当前使用50%速度（-0.25 m/s），以改善策略对负值命令的响应
- ✅ **前进和转向**：与原项目完全一致

---

## 7. 配置文件对比

### 7.1 原项目配置（参考）

```yaml
# 控制速度
forward_speed: [-0.5, 0.5]
left_speed: [-0.3, 0.3]
turn_speed: 0.7853975

# 仿真参数
timestep: 0.001s
frame_skip: 5
action_skip: 4
policy_freq: 50 Hz

# PD控制
kps: [30] × 12
kds: [1.0] × 12

# 动作缩放
action_scale: [0.125, 0.25, 0.25] × 4
```

### 7.2 OrcaGym当前配置

```yaml
# configs/lite3_onnx_sim_config.yaml
command_model:
  "flat_terrain":
    "forward_speed": [-0.5, 0.5]
    "left_speed": [-0.3, 0.3]
    "turn_speed": 0.7853975
    "turbo_scale": 3.0

# run_lite3_sim.py
TIME_STEP = 0.001
FRAME_SKIP = 5
ACTION_SKIP = 4
REALTIME_STEP = 0.02s  # 50 Hz

# Lite3_config.py
kps: [30] × 12
kds: [1.0] × 12  # 已修改为与原项目一致
action_scale: [0.25] × 12
base_born_height_offset: 0.101  # 已调整（提高10cm）
```

---

## 8. 总结

### ✅ 完全一致的部分
1. **仿真频率**：物理仿真1000Hz，策略更新50Hz
2. **控制速度**：前进/后退/转向速度完全一致
3. **命令归一化**：归一化方式和参数一致
4. **观测计算**：观测维度和缩放参数一致
5. **默认关节位置**：neutral和default位置一致

### ⚠️ 有差异的部分
1. **后退速度**：原项目-0.5 m/s，OrcaGym当前-0.25 m/s（降低50%以改善策略响应）
2. **action_scale**：原项目不同关节不同，OrcaGym统一为0.25（简化处理）
3. **命令平滑**：OrcaGym添加了指数移动平均（α=0.3）以减少命令突变

### 🎯 建议
1. **保持当前配置**：当前配置已基本匹配原项目，左右移动已修复为对称
2. **后退速度**：当前降低50%以改善策略响应，如需完全匹配可恢复为-0.5 m/s
3. **命令平滑**：已添加指数移动平均以减少命令突变，改善控制稳定性
4. **Kd值**：已修改为1.0，与原项目一致

---

**文档版本**: v1.0  
**最后更新**: 2024  
**对比基准**: Lite3_rl_deploy vs OrcaGym-dev

